#!/bin/sh /etc/rc.common
. /tmp/loader

START=01

boot()
{
	[ -e "/etc/init.d/apply_profile" ] && return 0

	case "$CONFIG_PROFILE" in
		*_ap)
			# typically the mesh is on channel 11
			uci set wireless.radio0.channel="$( _math random_integer 1 7 )"
		;;
	esac

	[ -n "$LOWMEM" ] && {
		# disable unneeded task during normal operation:
		grep "::askconsole:" "/etc/inittab" | grep -q ^"#" || {
			sed -i 's/^.*::askconsole:.*/# &/' "/etc/inittab"
		}

		grep "::askfirst:" "/etc/inittab" | grep -q ^"#" || {
			sed -i 's/^.*::askfirst:.*/# &/' "/etc/inittab"
		}

		case "${CONFIG_PROFILE}-${NODENUMBER}" in
			lisztwe_ap-15)
			;;
			*)
				[ -n "$( uci get dhcp.@dnsmasq[0].dhcpscript )" ] && uci delete dhcp.@dnsmasq[0].dhcpscript
			;;
		esac

		case "$CONFIG_PROFILE" in
			*_ap)
				[ -z "$( uci get olsrd.@meta[0].hnaslave )" ] && {
					_net local_inet_offer >/dev/null || uci set olsrd.@meta[0].hnaslave=1
				}
			;;
			*_adhoc)
				[ -e "/www/SIMPLE_MESHNODE" ] || {
					# unforce stricter kmodule unloading
					touch "/www/SIMPLE_MESHNODE"
					rm "/www/GOOD_MODULE_UNLOAD"
				}
			;;
		esac
	}

	case "$CONFIG_PROFILE" in
		leonardo*)
			uci set olsrd.@meta[0].hnaslave=0
		;;
		marinabh_ap)
			uci set wireless.radio0.htmode="HT20"
		;;
		adagio_adhoc|adagio_hybrid)
			uci set wireless.radio0.channel="11"
			uci set wireless.@wifi-iface[0].bssid="02:ca:ff:ee:00:11"
		;;
		rehungen*)
			case "$HARDWARE" in
				"TP-LINK TL-WR1043ND")
				;;
				*)
					uci set dhcp.lan.ignore=1
					uci set dhcp.wlan.ignore=1
				;;
			esac
		;;
		boltenhagen*)
			case "$( uci get system.@profile[0].nodenumber )" in
				2|34|139)
					# master, surfstation IB + DH
				;;
				*)
					uci set dhcp.lan.ignore=1
				;;
			esac

			case "$CONFIG_PROFILE" in
				*ap)
					uci set wireless.radio0.htmode="HT20"

					grep -q "sven-ola" "/etc/init.d/olsrd" && {
						uci set olsrd.@Interface[0].speed=20
					}

					case "$NODENUMBER" in
						# node 2 = nexthop
						xxx30)
							uci set olsrd.@olsrd[0].disabled=1
							touch "/tmp/service_olsrd_nowatching"
						;;
					esac

					is_room_dorfhotel()	# later via hostname
					{
						case "$NODENUMBER" in
							6|71|75|76|77|78|79|80|83|84|85|86|87|88|89|90|92|95|96|97|98|99|101|102|103|104|105|106|108|142|143|144|146)
								return 0
							;;
							*)
								return 1
							;;
						esac
					}

					is_room_iberotel()	# later via hostname
					{
						case "$NODENUMBER" in
							3|4|5|8|9|10|11|12|13|14|15|16|17|18|20|21|22|23|24|25|26|27|28|29|30|31|32|33|34|35|36|37|38|39|40|41|42|43|44|45|46|47|48|49|50|51|52|53|54|55|56|57|58|59|60|61|62|63|64|65|66|67|68|69|72|73)
								return 0
							;;
							*)
								return 1
							;;
						esac
					}

					is_room_dorfhotel && uci set wireless.@wifi-iface[0].ssid="Dorfhotel $NODENUMBER"
					is_room_iberotel  && uci set wireless.@wifi-iface[0].ssid="Iberotel $NODENUMBER"
				;;
			esac
		;;
		ffweimar*)
		;;
		schoeneck*)
			case "$( uci get wireless.@wifi-iface[0].mode )" in
				ap)
					uci set wireless.@wifi-iface[0].ssid="IFA Schoeneck $( uci get system.@profile[0].nodenumber )"
				;;
				adhoc)
					uci set wireless.@wifi-iface[0].bssid="02:ca:ff:ee:00:11"
					uci set wireless.radio0.channel="11"
					uci set wireless.radio0.htmode="HT40-"
					uci set wireless.@wifi-iface[0].ssid="o"
				;;
			esac

			case "$NODENUMBER" in
				228|230|234|231|235|232|229)
					# all switched together, netio230b on master
					uci set dhcp.lan.ignore=1
				;;
			esac
		;;
		*)
			[ -e "/lib/modules/$( uname -r )/b43.ko" ] && {
				local file="/lib/wifi/mac80211.sh"
				local keyword="keyspec}"	# must be at the end of a line
				local command1='config_get bitrates "$device" bitrates'
				local command2='test -n "$bitrates" \&\& iw dev "$ifname" set bitrates legacy-2.4 $bitrates'

				[ "$( uci get wireless.@wifi-iface[0].mode )" = "adhoc" ] && {
					[ -n "$( uci get wireless.radio0.bitrates )" ] || {
						uci set wireless.radio0.bitrates="6 9 12 18 24 36 48 54"

						case "$( uci get wireless.@wifi-iface[0].mcast_rate )" in
							1000|2000|5500|11000)
								uci delete wireless.@wifi-iface[0].mcast_rate
							;;
						esac
					}

					grep -q "$keyword"$ "$file" && {
						sed -i "s/$keyword$/$keyword ; $command1 ; $command2 /" "$file"
					}
				}
			}
		;;
	esac

	case "$HARDWARE" in
		"Buffalo WHR-HP-G54")
			case "$( uci get wireless.radio0.rxantenna )-$( uci get wireless.radio0.txantenna )" in
				"1-1")
				;;
				*)
					uci set wireless.radio0.rxantenna=1
					uci set wireless.radio0.txantenna=1
					uci commit wireless
				;;
			esac
		;;
		"Linksys WRT54G"*)
			case "$( uci get wireless.radio0.rxantenna )-$( uci get wireless.radio0.txantenna )" in
				"0-0")
				;;
				*)
					uci set wireless.radio0.rxantenna=0
					uci set wireless.radio0.txantenna=0
					uci commit wireless
				;;
			esac
		;;
		"TP-LINK TL-WR1043ND")
			# use driver defaults
			uci delete wireless.radio0.txpower
		;;
	esac

	case "$( uci get wireless.radio0.hwmode )" in
		*"n"*)
			# 802.11n works with distributed beaconing
			uci set wireless.radio0.beacon_int=100
		;;
	esac

	case "$( uci get wireless.radio0.htmode )" in
		HT40*)
			uci set wireless.radio0.noscan="1"
		;;
	esac

	case "$CONFIG_PROFILE" in
		*hybrid)
			grep -q "wlanadhoc" "/etc/config/wireless" && {
				uci show network | grep ^"network.wlanadhoc=" || {
					uci set network.wlanadhoc=interface
					uci set network.wlanadhoc.proto=static
					uci set network.wlanadhoc.ipaddr=$(  uci get network.wlan.ipaddr )
					uci set network.wlanadhoc.netmask=$( uci get network.wlan.netmask )
				}
			}
		;;
	esac

	batman_needed()
	{
		[ -e "/usr/sbin/batctl" ] || return 1

		case "$CONFIG_PROFILE" in
			liszt28*)
				case "$NODENUMBER" in
					13|2|23|76|98|25|24|222|20|15|58|99|8)
						return 0
					;;
					*)
					;;
				esac
			;;
			dhsylt*)
				case "$NODENUMBER" in
					18|25|26)
					;;
					*)
						return 0
					;;
				esac
			;;
			olympia*)
			;;
		esac

		return 1
	}

	batman_kmodules_are_deactivated()
	{
		grep -q ^"#" "/etc/modules.d/50-batman-adv"
	}

	batman_kmodules_force_activation()
	{
		sed -i 's/^[^a-z]*//' "/etc/modules.d/50-batman-adv"
	}

	batman_kmodules_force_inactivation()
	{
		sed -i 's/^/# &/' "/etc/modules.d/50-batman-adv"
	}

	if batman_needed; then
		batman_kmodules_are_deactivated && batman_kmodules_force_activation
	else
		batman_kmodules_are_deactivated || batman_kmodules_force_inactivation
	fi

	batman_needed && {
		case "$CONFIG_PROFILE" in
			olympia_hybrid)
				uci set wireless.radio0.htmode="HT20"
				uci set wireless.@wifi-iface[0].ssid="o"
				uci set wireless.@wifi-iface[1].ssid="Hotel Olympia"
			;;
			liszt28_hybrid)
				uci set wireless.radio0.htmode="HT20"
				uci set wireless.@wifi-iface[0].ssid="o"
				uci set wireless.@wifi-iface[1].ssid="Schlachtfest"
			;;
			liszt28_ap)
				uci set wireless.radio0.htmode="HT20"
				uci set wireless.@wifi-iface[0].ssid="Schlachtfest"
			;;
			dhsylt_hybrid)
				uci set wireless.radio0.htmode="HT20"
				uci set wireless.@wifi-iface[0].ssid="o"
				uci set wireless.@wifi-iface[1].ssid="Dorfhotel Sylt"
			;;
			dhsylt_ap)
				uci set wireless.radio0.htmode="HT20"
				uci set wireless.@wifi-iface[0].ssid="Dorfhotel Sylt"
			;;
		esac

		local dns_ip
		local router_ip
		case "$CONFIG_PROFILE" in
			dhsylt*|olympia*)
				router_ip="192.168.2.1"
				dns_ip="$router_ip"
			;;
			liszt28*)
				router_ip="192.168.99.1"
				dns_ip="$router_ip"
			;;
		esac

		uci add network alias
		uci set network.@alias[-1].interface="lan"
		uci set network.@alias[-1].proto=batadv
		uci set network.@alias[-1].mesh=bat0

		# [ -n "$( uci get network.lan )" ] && yes

		uci add network alias
		uci set network.@alias[-1].interface="wan"
		uci set network.@alias[-1].proto=batadv
		uci set network.@alias[-1].mesh=bat0


		integer2fourhex()	# e.g. 8 -> 00:08
		{			# fixme! max = 999 fixme! generalize it, join with bssid_wellformed()
			if [ $1 -lt 100 ]; then
				if [ $1 -lt 10 ]; then
					echo "00:0$1"
				else
					echo "00:$1"
				fi
			else
				echo "0$( echo "$1" | cut -b 1 ):$( echo "$1" | cut -b 2-3 )"
			fi
		}

		case "$CONFIG_PROFILE" in
			*hybrid)
				uci add network alias
				uci set network.@alias[-1].interface="wlanadhoc"
				uci set network.@alias[-1].proto=batadv
				uci set network.@alias[-1].mesh=bat0

				# ap-interface
				# wireless.@wifi-iface[0].network=wlan
				local varname="$( uci show | grep "\.network=wlan"$ | head -n1 | cut -d'=' -f1 | sed 's/\.network//' )"
				uci set $varname.macaddr="02:00:ca:fe:$( integer2fourhex "$NODENUMBER" )"
			;;
			*adhoc)
				uci add network alias
				uci set network.@alias[-1].interface="wlan"
				uci set network.@alias[-1].proto=batadv
				uci set network.@alias[-1].mesh=bat0
			;;
		esac

		uci set network.lan.macaddr="02:00:ca:b1:$( integer2fourhex "$NODENUMBER" )"
		uci set network.wan.macaddr="02:00:de:ad:$( integer2fourhex "$NODENUMBER" )"

		case "$CONFIG_PROFILE" in
			*hybrid|*ap)
				echo "brctl addif br-mybridge wlan0" >>"/tmp/WIFI_SPECIALS.sh"
			;;
		esac

#		echo "dnsmasq --address=/#/10.63.$NODENUMBER.1 -p 5353" >>"/tmp/WIFI_SPECIALS.sh"

		uci set network.mybridge="interface"
		uci set network.mybridge.type="bridge"
		uci set network.mybridge.ifname="bat0"
		uci set network.mybridge.proto="static"
		uci set network.mybridge.ipaddr="192.168.$NODENUMBER.1"
		uci set network.mybridge.netmask="255.255.0.0"

		case "$CONFIG_PROFILE" in
			*_adhoc|*_hybrid)
				uci set batman-adv.bat0.bridge_loop_avoidance=1
			;;
		esac

		if _net local_inet_offer >/dev/null; then
			uci set batman-adv.bat0.gw_mode=server
			uci set batman-adv.bat0.gw_bandwidth="16384kbit/16384kbit"
		else
			:
#			uci set batman-adv.bat0.gw_bandwidth="512kbit/512kbit"
		fi

		uci set dhcp.mybridge=dhcp
		uci set dhcp.mybridge.interface=mybridge
		uci set dhcp.mybridge.start=2
		uci set dhcp.mybridge.limit=253
		uci set dhcp.mybridge.leasetime=12h
		uci set dhcp.mybridge.force=1
		uci set dhcp.mybridge.ignore=0
		uci set dhcp.mybridge.netmask=255.255.0.0
		uci set dhcp.mybridge.dhcp_option="option:router,$router_ip,$dns_ip"	# fixme! dynamic set during runtime

		uci set dhcp.wlan.ignore=1
	}

	case "$CONFIG_PROFILE" in
		liszt28*)
			grep -q "unlimited" "/lib/wifi/hostapd.sh" || {
				sed -i 's/hostapd -P/ulimit -c unlimited; &/' /lib/wifi/hostapd.sh
			}
		;;
	esac
}
