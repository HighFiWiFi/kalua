#!/bin/sh

. /bin/needs base http log

eval $(func_http_sanitize_query_string)		# LOGIN={md5sum_of_user+pass}

[ -z "$LOGIN" ] && {
	func_log no_args daemon info "no login-data given - abort"
	exit
}

func_http_header_mime_output text/plain

FILE="/www/cgi-bin/userdata.txt"		# md5sum no. min user pass
LOGFILE="/www/users_logged_in"

DATE="$( date )"
DNS="$( nslookup ${REMOTE_ADDR:=127.0.0.1} | sed -n 's/^Name:[^a-zA-Z0-9]*\(.*\)\.olsr/\1/p' )"		# https?
OUT="'$DATE' - IP:'$REMOTE_ADDR' - DNS:'${DNS:-unresolveable}' = HASH:'$LOGIN'"

[ ! -e "$FILE" ] && {
	echo "1"
	echo "$OUT | ok | no_userdata" >>$LOGFILE
	func_log no_userdata daemon alert "login_ok: $OUT"
	exit
}

USER="$( grep ^"$LOGIN" "$FILE" )" && {
	echo "1"
	echo "$OUT | ok | $USER" >>$LOGFILE
	func_log user_ok daemon alert "login_ok: '$LOGIN' - $OUT"
	exit
}

echo "$OUT | failed" >>$LOGFILE
func_log user_mismatch daemon alert "login_failed: $OUT"
echo "0"
