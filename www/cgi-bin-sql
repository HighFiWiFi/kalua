#!/bin/sh

. /bin/needs base http log

eval $(_http query_string_sanitize)		# LOGIN={md5sum_of_user+pass} | MAC=00:11:22:33:44:55 | SIGNAL=-64 | KEYWORD=username+pass

[ -z "$LOGIN" ] && {
	_log do no_args daemon info "no login-data given - abort"
	exit
}

_http header_mimetype_output text/plain

FILE="/www/cgi-bin/userdata.txt"		# md5sum no. min user pass
LOGFILE="/www/users_logged_in"

DATE="$( date )"
DNS="$( nslookup ${REMOTE_ADDR:=127.0.0.1} | sed -n 's/^Name:[^a-zA-Z0-9]*\(.*\)\.olsr/\1/p' )"		# https?
OUT="'$DATE' - IP:'$REMOTE_ADDR' - DNS:'${DNS:-unresolveable}' = HASH:'$LOGIN' - MAC:'$MAC' - SIGNAL:'$SIGNAL' - KEYWORD:'$KEYWORD'"

[ ! -e "$FILE" ] && {
	echo "1"
	echo "$OUT | ok | no_userdata" >>$LOGFILE
	_log do no_userdata daemon alert "login_ok: $OUT"
	exit
}

USER="$( grep ^"$LOGIN" "$FILE" )" && {
	echo "1"
	echo "$OUT | ok | $USER" >>$LOGFILE
	_log do user_ok daemon alert "login_ok: '$LOGIN' - $OUT"
	exit
}

echo "$OUT | failed" >>$LOGFILE
_log do user_mismatch daemon alert "login_failed: $OUT"
echo "0"
