func_db_html_out ()
{
	sqlite3 /tmp/admin2.db "select * from USERS;" |
	 awk -v DATUM="$( date )" 'BEGIN{
		print "<html><body><big>WLAN-Benutzerliste, '1-Wochen-Tickets'&nbsp;&nbsp;&nbsp;</big>"
		print "<small>Erstellungszeitpunkt: "DATUM"</small>"
		print "<table cellspacing='1' cellpadding='1' border='1' width='100%'>"
		print "<tr width='100%'><td align='center' width='5%'> Benutzername </td>"
		print "<td align='center' width='5%'> Passwort </td>"
		print "<td align='center' width='5%'> Zimmernummer </td>"
		print "<td align='center' width='85%'>Kommentar</td></tr>"
	}{
		FS="|"
		print "<tr><td>&nbsp;&nbsp;"$4"</td><td align='center'>"$5"</td><td>&nbsp;</td><td>&nbsp;</td>"
	}'
}

func_db_dirty_out ()
{
	local TICKET="1week"
	local      C="77"
	
	sqlite3 /tmp/admin2.db "select * from USERS;" |
	 while read LINE; do {
	 
	 	IFS="|"
	 	set $LINE		# md5sum id profile_name username password
	 	
	 	echo "$( echo -n "$4$5" | md5sum | cut -d' ' -f1 ) $C $TICKET $4 $5"
	 	C=$(( $C + 1 ))
	} done	
}

func_db_defs ()
{
	SQL_DB="/tmp/admin2.db"
	SQL_BIN="$( which sqlite3 )"

	[ ! -e "$SQL_DB" ] && {		# fixme! check 0 size?
		func_log db_defs daemon info "creating database '$SQL_DB'"
		func_db_init
	}
}

func_db_init ()
{
	func_db_init_sql | "$SQL_BIN" "$SQL_DB"
}

func_db_init_sql ()		# outputs an complete sqlite-query, which creates all tables/triggers
{
	local TABLE TABLES_LIST TABLE_INIT NAME NAMES_LIST

	TABLES_LIST="$( func_db_tables all )"
	NAMES_LIST="$(  func_db_tables USERNAMES init_defaults )"
	
	echo "begin;"
	echo

	for TABLE in $TABLES_LIST; do {
		TABLE_INIT="$( func_db_tables $TABLE init )"
		echo "create table '$TABLE' ( $TABLE_INIT );"
	} done

	for NAME in $NAMES_LIST; do {					# fill a table with useable 'USERNAMES'
		echo "insert into 'USERNAMES' values ( '$NAME' );"	# which is only used by the trigger 'auto_user'
	} done

	cat <<EOF
	
create trigger 'auto_pass' after insert on 'USERS'
  begin
    update 'USERS' set pass = substr(abs(random()),1,5) where pass = 'auto';
  end;
	
create trigger 'auto_user' after insert on 'USERS'
  begin
    update 'USERS' set name = (select name from 'USERNAMES'  where rowid >= (abs(random()) % (select max(rowid) from 'USERNAMES')) limit 1) where name = 'auto';
  end;

create trigger 'auto_time' after insert on 'USERS'
  begin
    update 'USERS' set installed = strftime('%s','now') where installed = 'auto';
  end;
	
create trigger 'no_rowid_holes' after delete on 'USERS'
  begin
    update 'USERS' set rowid = old.rowid where rowid = (select count()+1 from USERS);
  end;

EOF

	echo "commit;"
}

func_schrott ()
{
	echo "begin;"

	for I in 1 2 3 ; do {			# insert some USERS
		for OBJ in 1 2 3 ; do {
			echo "insert into 'USERS' values ( NULL, 'profil' , 'Zimmer 10$OBJ', 'auto', 'auto', 'auto', '$OBJ' );"
		} done
	} done

	echo "insert into 'PROFILES' values ( NULL, 'Kurz-Ticket', 'fuer ca. 20 Minuten', 2, 200, 200, 50, 50, 180, 180, 'http://hier.com', 5, 'EUR' );"
	echo "insert into 'PROFILES' values ( NULL, 'Tagesticket', 'fuer 24 Stunden', 2, 500, 1200, 100, 100, 1800, 1800, 'http://hier.com', 10, 'EUR' );"
	echo "insert into 'PROFILES' values ( NULL, '2-Tages-Ticket', 'fuer 48 Stunden', 2, 1200, 2200, 120, 120, 1800, 1800, 'http://hier.com', 15, 'EUR' );"
	echo "insert into 'PROFILES' values ( NULL, 'Mitarbeiterticket', 'fuer einen Monat', 2, 8200, 16200, 150, 150, 2800, 2800, 'http://hier.com', 0, 'EUR' );"

	for I in 1 2 3; do {
		echo "insert into 'DEVICES' values ( $I, '00:11:22:33:44:0$I', 'wifi', 'de', '', '', '', '', '', '', 1);"
	} done
	
	echo "commit;"
}

func_db_insert_tickets ()			# trigger: name = auto , pass = auto
{						# "select name from NAMES where rowid>=random() % (SELECT max(rowid) FROM NAMES) limit 1"
	local TICKET

	echo "$SQL_BIN $SQL_DB \"BEGIN;"
	
	for TICKET in $FORM_USERADD_COUNT; do {
		echo -n "insert into 'USERS' values ( "
		echo -n "NULL, '$FORM_USERADD_PROFILE' , '$FORM_USERADD_COMMENT', '$FORM_USERADD_NAME', '$FORM_USERADD_PASS', strftime('%s','now'), $FORM_USERADD_DEVICES )"
	} done
	
	echo "COMMIT\""
}

func_db_tables ()
{
	local TABLE="$1"
	local VIEW="$2"
	
	case $TABLE in
		all)
			echo -n "DEVICES USERS USERNAMES PROFILES"
		;;
		DEVICES)
			case $VIEW in
				all)
					echo -n "user mac devtype lang firstseen lastseen timeall timetoday traffall trafftoday isolation"
				;;
				init)
					echo -n "user INTEGER, mac TEXT, devtype TEXT, lang TEXT, firstseen INTEGER, lastseen INTEGER,"
					echo -n "timeall INTEGER, timetoday INTEGER, traffall INTEGER, trafftoday INTEGER, isolation INTEGER"
				;;
			esac	
		;;
		USERS)
			case $VIEW in
				all)
					echo -n "id profile comment name pass installed devices"
				;;
				init)
					echo -n "id INTEGER PRIMARY KEY, profile TEXT, comment TEXT, name TEXT, pass TEXT, installed INTEGER, devices INTEGER"
				;;
			esac	
		;;
		PROFILES)
			case $VIEW in
				all)
					echo -n "id name comment validity maxtraffall maxtraffday maxspeedup maxspeeddown maxtimeall maxtimeday landingurl cost currency"
				;;
				init)
					echo -n "id INTEGER PRIMARY KEY, name TEXT, comment TEXT, validity INTEGER, maxtraffall INTEGER, maxtraffday INTEGER,"
					echo -n "maxspeedup INTEGER, maxspeeddown INTEGER, maxtimeall INTEGER, maxtimeday INTEGER, landingurl TEXT, cost TEXT, currency TEXT"
				;;
			esac
		;;
		USERNAMES)
			case $VIEW in
				all)
					echo -n "name"
				;;
				init)
					echo -n "name TEXT"
				;;
				init_defaults1)
					echo -n "pinguin delphin giraffe elefant loewe tiger leopard wildkatze uhu fuchs gazelle wolf schwan buntspecht eisbaer "
					echo -n "polarfuchs blauwal hai schildkroete zebra bueffel braunbaer hirsch reh goldfisch katze bernhardiner schaeferhund "
					echo -n "pudel eichhoernchen ameisenbaer honigbiene schmetterling kolibri schneeeule vogelspinne hase wellensittich adler "
					echo -n "meerkatze pelikan robbe erdmaennchen pfauenauge gorilla orangutan condor habicht amsel drossel fink star yak "
					echo -n "krokodil ameisenbaer yeti gnu tintenfisch fasan rebhuhn stockente haubentaucher bachstelze spitzmaus maulwurf "
					echo -n "goldhamster pony pandabaer storch strauss einhorn schwalbe eisvogel kranich"
				;;
				init_defaults)
					echo -n "behringer borchers borowski pedda blume boettcher botto brueckner burger burghardt coppa ebersbach eissner ernert "
					echo -n "fischerart goethner gille gnuechtel griesel haeussler hartmann heisig heublein horlbeck kappler hund huniat jahr "
					echo -n "killisch kober kollwitz kratsch kristofori kunert lehmann loy mattheuer mayerforeyt minkewitz mohr mueller "
					echo -n "muellersimon munse muenze murschetz naumann novaky penck petersdorf petkova piniek pillwitz poetzschig rauch "
					echo -n "richter rink rossmanit ruddigkeit schade schletter schultheiss scholz schroeter albertschulz schwimmer sologubov "
					echo -n "stauf suessmilch stelzmann thal triegel touma tuebke vancura vent voigt voelkel wagenbrett wajsberg weischer "
					echo -n "zettl zickelbein ziegler zumor zuerner"
				;;
				init_defaultsX)
					echo -n "kabul kairo tirana algier luanda malabo eriwan baku canberra manama dhaka bridgetown belmopan cotonou thimphu "
					echo -n "sucre sarajewo gaborone sofia ouagadougou bujumbura taipeh peking kopenhagen berlin roseau quito yamoussoukro "
					echo -n "abidjan asmara tallinn suva helsinki paris libreville banjul tiflis accra athen conakry bissau tegucigalpa "
					echo -n "jakarta bagdad teheran dublin jerusalem rom tokio amman ottawa astana doha nairobi bischkek kinshasa brazzaville "
					echo -n "seoul zagreb havanna vientiane maseru riga beirut monrovia vaduz vilnius antananarivo lilongwe putrajaya bamako "
					echo -n "valletta rabat majuro nouakchott skopje palikir monaco ulaanbaatar podgorica maputo pyinmana windhoek kathmandu "
					echo -n "wellington managua amsterdam niamey abuja oslo maskat wien dili islamabad lima manila warschau lissabon kigali "
					echo -n "bukarest moskau honiara lusaka apia riad stockholm bern dakar belgrad freetown harare singapur bratislava "
					echo -n "ljubljana mogadischu madrid colombo basseterre castries kingstown pretoria kapstadt khartum paramaribo mbabane "
					echo -n "damaskus duschanbe dodoma bangkok prag tunis ankara aschgabat funafuti kampala kiew budapest montevideo taschkent "
					echo -n "vatikanstadt caracas london hanoi minsk bangui nikosia"
				;;
			esac
		;;
	esac
}
