# func_unixtime
# func_toggle_values
# func_admingui_get_action
# func_admingui_links2category
# func_admingui_javascript
# func_admingui_user_add_form_was_send
# func_admingui_user_add_form
# func_db_user
# func_db_devices
# func_db_profile


# todo
#
# - user-editor: 
#   - werte uebernehmen
#     - zuerst SQL-Syntax schreiben und dann eval
#   - user anzeigen
#
# - profil-editor: neues profil = muell-profil erzeugen + dieses bearbeiten
#   - table PROFIL leer? -> direkt in profil-editor gehen
#   - profil-editor: profil loeschen

func_unixtime ()
{
	date +%s
}

func_toggle_values ()
{
	local VALUE_NOW="$1"
	local VALUE_A="$2"
	local VALUE_B="$3"

	if [ "$VALUE_NOW" = "$VALUE_B" ]; then
		echo -n "$VALUE_A"
	else
		echo -n "$VALUE_B"		# is also the initial value
	fi
}

func_admingui_get_action ()
{
	case $1 in
		all)
			echo "user_add user_edit user_show profile_add profile_edit"
		;;
		user_add)
			echo "EXPERT='false'"
			echo "DESC_SHORT='Benutzer hinzuf&uuml;gen'"
			echo "DESC_LONG='neue Benutzer im System anlegen'"
		;;
		user_edit)
			echo "EXPERT='false'"
			echo "DESC_SHORT='Benutzer bearbeiten'"
			echo "DESC_LONG='vorhandene Benutzer bearbeiten'"
		;;
		user_show)
			echo "EXPERT='false'"
			echo "DESC_SHORT='Benutzer anzeigen'"
			echo "DESC_LONG='alle angelegten Benutzer anzeigen'"
		;;
		profile_add)
			echo "EXPERT='true'"
			echo "DESC_SHORT='Benutzerprofil erstellen'"
			echo "DESC_LONG='ein neues Benutzerprofil anlegen'"
		;;
		profile_edit)
			echo "EXPERT='true'"
			echo "DESC_SHORT='Benutzerprofile bearbeiten'"
			echo "DESC_LONG='Benutzerprofile bearbeiten oder l&ouml;schen'"
		;;
		*)
			echo "EXPERT='false'"
			echo "DESC_SHORT='Auswahl'"
			echo "DESC_LONG='hier werden Benutzer oder Profile verwaltet'"
		;;
	esac
}

func_admingui_links2category ()
{
	local ACTION BGCOLOR DESC DESC_SHORT DESC_LONG EXPERT
	
	for ACTION in $(func_admingui_get_action all); do {
		
		BGCOLOR="$( func_toggle_values "$BGCOLOR" "#FAEBD7" "#DCDCDC" )"

		eval $(func_admingui_get_action $ACTION)                          

		echo -n "<td bgcolor='$BGCOLOR' align='center'>"
		
		[ "$EXPERT" = "true" ] && echo -n "<table class='trg' style='display: none; visibility: hidden;'><tr><td align='center'>"
		
		echo -n "<form method='GET'>"
		echo -n "<input type='hidden' name='FORM_ACTION' value='$ACTION'><input type='submit' value='$DESC_SHORT'></form>"
		echo -n "$DESC_LONG</td>"
		
		[ "$EXPERT" = "true" ] && echo -n "</td></tr></table>"
	} done
}

func_admingui_javascript ()		# http://www.tutorials.de/forum/javascript-ajax/329323-tabellenzeilen-verstecken-anzeigen.html
{
	cat<<EOF
	<SCRIPT LANGUAGE="JavaScript" TYPE="text/javascript"><!--

	function getElementsByClassName(strClassName)
	{
		var arrHelp = new Array();
		var strPattern = eval("/"+strClassName+"/");
		var arrTags = (navigator.userAgent.toLowerCase().indexOf("msie") != -1) ? document.all : document.getElementsByTagName('*');

		for(varEntry in arrTags){
			if((arrTags[varEntry].className) && (arrTags[varEntry].className.match(strPattern))){
				arrHelp[arrHelp.length] = arrTags[varEntry];
			}
		}

		return arrHelp;
	}

	function toggleMe(item)
	{
		var e=getElementsByClassName(item);
	
		if(!e)return true;

		for (var i = 0; i < e.length; i++){
			with (e[i].style){
				if(visibility == 'hidden' || display=='none'){
					display = '';
					visibility = 'visible';
				}else{
					display = 'none';
					visibility = 'hidden';
				}
			}
		}

		return true;
	}
	--></SCRIPT>
EOF
}

func_admingui_user_add_form_was_send ()
{
	local FUNC="admingui_user_add_form_was_send"
	local COUNT="$FORM_USERADD_COUNT"
	local TEMP="/tmp/tempfile_user_add_form_was_send_$$"
	local BEGIN="true"

	func_log $FUNC daemon debug "adding $COUNT users into 'USERS' with profile '$FORM_USERADD_PROFILE_ID'"
	
	if [ "$COUNT" -gt 1 ]; then
		echo -n "<h2>Es werden $FORM_USERADD_COUNT Benutzer angelegt.</h2>"
	else
		echo -n "<h2>Es wird $FORM_USERADD_COUNT Benutzer angelegt.</h2>"
	fi
	
	echo -n "<pre>"
	
	while [ "$COUNT" -gt 0 ]; do {		# (COUNT) USER_ID PROFILE_ID COMMENT USERNAME PASSWORD INSTALLED DEVICE_MAX
		COUNT=$(( $COUNT - 1 ))
	
		[ "$BEGIN" = "true" ] && echo "begin;" && BEGIN="false"
		
		echo -n "  insert into 'USERS' values ("
		echo -n "  NULL ,"				# row/user_id
		echo -n "  '$FORM_USERADD_PROFILE_ID',"
		echo -n "  '$FORM_USERADD_COMMENT' ,"
		echo -n "  '$FORM_USERADD_USERNAME' ,"
		echo -n "  '$FORM_USERADD_PASSWORD' ,"
		echo -n "  'auto' ,"				# installed
		echo -n "  '$FORM_USERADD_DEVICES_MAX'"
		echo    " );"
	
	} done >$TEMP
	
	if [ -e "$TEMP" ]; then
	
		echo "commit;" >>$TEMP
		cat $TEMP
		$SQL_BIN $SQL_DB <$TEMP
		rm $TEMP
		func_log $FUNC daemon info "created $FORM_USERADD_COUNT users with profile '$FORM_USERADD_PROFILE_ID'"
	else
		func_log $FUNC daemon alert "something went wrong"
	fi
	
	echo -n "</pre>"
}

func_admingui_user_add_form ()
{
	local N SWITCH EXPERT COUNT VALUE BGCOLOR FORM_TYPE DESC DESC_SHORT DESC_LONG DEFAULT_VAL DEFAULT_TXT

	echo -n "<form method='get' accept-charset='ISO-8859-1'><input type='hidden' name='FORM_ACTION' value='user_add'><input type='hidden' name='FORM_SEND' value='true'>"
	echo -n "<table id='tabID' cellspacing='0' cellpadding='2' border='0' width='100%'><tr><td width='10%'>&nbsp;</td><td width='10%'>&nbsp;</td><td width='80%'>&nbsp;</td></tr>"
	
	for VALUE in $(func_db_user all); do {

		BGCOLOR="$( func_toggle_values "$BGCOLOR" "#FAEBD7" "#DCDCDC" )"
					 
		eval $(func_db_user $VALUE)

		if [ "$EXPERT" = "true" ]; then
			[ "$SWITCH" != "true" ] && {
				SWITCH="true"
				echo -n "<tr><td colspan='3' align='right' bgcolor='$BGCOLOR'>"
				echo -n "<a href='#' ONCLICK=\"toggleMe('trg');\">Zusatzeinstellungen anzeigen</a></td></tr>"
				BGCOLOR="$( func_toggle_values "$BGCOLOR" "#FAEBD7" "#DCDCDC" )"
			}
			echo -n "<tr class='trg' style='display: none; visibility: hidden;'>"
		else
			echo -n "<tr>"
		fi
		
		echo -n "<td bgcolor='$BGCOLOR'>${DESC_SHORT}&nbsp;&nbsp;</td><td bgcolor='$BGCOLOR'>"
		
		case $FORM_TYPE in
			radio)
				echo -n "<input type='radio' name='FORM_USERADD_$VALUE' value='$DEFAULT_VAL' checked> $DEFAULT_TEXT"
				echo -n "<input type='radio' name='FORM_USERADD_$VALUE' value='$DEFAULT_VAL1'       > $DEFAULT_TEXT2"
			;;
			select)
				echo -n "<select size='1' name='FORM_USERADD_$VALUE'>"
				for OPTION in $DEFAULT_VALS; do {
					echo -n "<option value='$OPTION'>$( eval $( echo -n echo -n \$DEFAULT_TXT${N} ) )</option>"
					N=$(( $N + 1 ))
				} done && N=
				echo -n "</select>"
			;;
			*)
				echo -n "<input type='text' name='FORM_USERADD_$VALUE' value='$DEFAULT_VAL'>"
			;;
		esac
		
		echo -n "</td><td bgcolor='$BGCOLOR'>&nbsp;&nbsp;${DESC_LONG}</td></tr>"
	} done

	echo -n "<tr><td colspan='3'>&nbsp;</td></tr><tr><td valign='middle' align='center' bgcolor='#D3D3D3' colspan='2'><br>"
	echo -n "<input type='submit' value='Benutzer anlegen'><br><br></td><td bgcolor='#D3D3D3'>&nbsp;</td></tr></table>"
}

func_admingui_user_edit_form ()
{
	echo "<pre>"
	$SQL_BIN $SQL_DB "select * from USERS;"
	echo "</pre>"
}

func_db_user ()
{
	case $1 in
		all)
			# USER_ID PROFILE_ID COMMENT USERNAME PASSWORD INSTALLED DEVICE_MAX
		
			[ "$2" = "sql" ] && echo -n "ID INSTALLED FIRSTSEEN LASTSEEN TRAFFALL TRAFFTODAY TIMEALL TIMETODAY "
			echo -n "COUNT PROFILE_ID COMMENT USERNAME PASSWORD MAC DEVICES_MAX ISOLATION"

			# echo -n "USER_ID PROFILE_ID COMMENT USERNAME PASSWORD INSTALLED DEVICE_MAX"
			# echo -n "COUNT "
		;;
		init)
			local SEPARATE OBJ LIST="$( func_db_user all sql )"
			
			for OBJ in $LIST; do {
				eval $(func_db_user $OBJ)
				[ -z "SQLCLASS" ] && continue
				echo -n "${SEPARATE}${OBJ} $SQLCLASS" && SEPARATE=","
			} done 
		;;
		COUNT)
			echo "SQLCLASS=''"
			echo "EXPERT='false'"
			echo "FORM_TYPE='text'"
			echo "DEFAULT_VAL='1'"
			echo "DESC_SHORT='Benutzeranzahl'"
			echo "DESC_LONG='wieviele Benutzer sollen angelegt werden?'"
		;;
		USERNAME)
			echo "SQLCLASS='TEXT'"
			echo "EXPERT='true'"
			echo "FORM_TYPE='text'"
			echo "DEFAULT_VAL='auto'"
			echo "DESC_SHORT='Benutzername'"
			echo "DESC_LONG='wird automatisch vorgegeben, kann auch manuell eingetragen werden'"
		;;
		PASSWORD)
			echo "SQLCLASS='TEXT'"
			echo "EXPERT='true'"			# user can alter this!?
			echo "FORM_TYPE='text'"
			echo "DEFAULT_VAL='auto'"
			echo "DESC_SHORT='Passwort'"
			echo "DESC_LONG='wird automatisch vorgegeben, kann auch manuell eingetragen werden'"	
		;;
		PROFILE_ID)
			local N PROFILE PROFILE_LIST="$( func_db_profile ID all )"
		
			echo "SQLCLASS='INTEGER'"
			echo "EXPERT='false'"
			echo "FORM_TYPE='select'"
			echo "DEFAULT_VALS='$PROFILE_LIST'"
			
			for PROFILE in $PROFILE_LIST; do {
				echo "DEFAULT_TXT${N}='$( func_db_profile DESC $PROFILE )'"
				N=$(( $N + 1 ))
			} done
			
			echo "DESC_SHORT='Profil'"
			echo "DESC_LONG='Zusammenfassung grundlegender Benutzerrechte (G&uuml;ltigkeitsdauer,&nbsp;...)'"
		;;
		MAC)
			echo "SQLCLASS='TEXT'"
			echo "EXPERT='true'"
			echo "FORM_TYPE='text'"
			echo "DEFAULT_VAL='auto'"		# space separated?
			echo "DESC_SHORT='MAC-Adresse'"
			echo "DESC_LONG='wird automatisch vorgegeben, kann auch manuell vergeben werden'"
		;;
		DEVICES_MAX)
			echo "SQLCLASS='INTEGER'"
			echo "EXPERT='true'"
			echo "FORM_TYPE='text'"
			echo "DEFAULT_VAL='1'"
			echo "DESC_SHORT='Ger&auml;teanzahl'"
			echo "DESC_LONG='Endger&auml;te die sich mit gleicher Kennung anmelden d&uuml;rfen (Gruppenticket)'"
		;;
		COMMENT)
			echo "SQLCLASS='TEXT'"
			echo "EXPERT='true'"
			echo "FORM_TYPE='text'"
			echo "DEFAULT_VAL='...'"
			echo "DESC_SHORT='Kommentar'"
			echo "DESC_LONG='interner Vermerk, z.B. Zimmernummer'"
		;;
		ISOLATION)
			echo "SQLCLASS='INTEGER'"
			echo "EXPERT='true'"
			echo "FORM_TYPE='radio'"
			echo "DEFAULT_VAL='1'"
			echo "DEFAULT_TXT='ja'"
			echo "DEFAULT_VAL1='0'"
			echo "DEFAULT_TXT1='nein'"
			echo "DESC_SHORT='Isolation'"
			echo "DESC_LONG='Schutz des Netzteilnehmers vor Zugriff durch andere Benutzer?'"
		;;
		ID)
			echo "SQLCLASS='INTEGER PRIMARY KEY AUTOINCREMENT'"	# eindeutiger bezeichner pro user-kennung
			echo "DEFAULT_VAL='NULL'"
			echo "EXPERT='sql'"
		;;
		INSTALLED)
			echo "SQLCLASS='INTEGER'"		# unixzeit / anlegezeitpunkt in DB
			echo "EXPERT='sql'"
			echo "DEFAULT_VAL='$( func_unixtime )'"
		;;
		FIRSTSEEN)
			echo "SQLCLASS='INTEGER'"		# unixzeit / erster erfolgreicher einlogvorgang
			echo "EXPERT='sql'"
			echo "DEFAULT_VAL='NULL'"
		;;
		LASTSEEN)
			echo "SQLCLASS='INTEGER'"		# unixzeit / letzter auslogvorgang
			echo "EXPERT='sql'"
			echo "DEFAULT_VAL='NULL'"
		;;
		TRAFFALL)
			echo "SQLCLASS='INTEGER'"		# traffic [megabyte] insgesamt
			echo "EXPERT='sql'"			# trafficmeldungen ("fetch me!" -> scp alle transaktionen)
			echo "DEFAULT_VAL='0'"
		;;
		TRAFFTODAY)
			echo "SQLCLASS='INTEGER'"		# traffic [megabyte] heute	// trafficmeldungen
			echo "EXPERT='sql'"
			echo "DEFAULT_VAL='0'"
		;;
		TIMEALL)
			echo "SQLCLASS='INTEGER'"		# minutenverbrauch insgesamt	// trafficmeldungen
			echo "EXPERT='sql'"
			echo "DEFAULT_VAL='0'"
		;;
		TIMETODAY)
			echo "SQLCLASS='INTEGER'"		# minutenverbrauch heute	// trafficmeldungen
			echo "EXPERT='sql'"
			echo "DEFAULT_VAL='0'"
		;;
	esac
}

func_db_devices ()
{
	case $1 in
		init)
			local SEPARATE OBJ LIST="$( func_db_devices all )"
		
			for OBJ in $LIST; do {
				eval $(func_db_devices $OBJ)
				echo -n "${SEPARATE}${OBJ} $SQLCLASS" && SEPARATE=","
			} done
		;;
		all)
			echo -n "USER MAC DEVTYPE LANG"
		;;
		USER)
			echo "SQLCLASS='INTEGER'"	# foreign key to table 'USER' ?
		;;
		MAC)
			echo "SQLCLASS='TEXT'"
		;;
		DEVTYPE)
			echo "SQLCLASS='TEXT'"
		;;
		LANG)
			echo "SQLCLASS='TEXT'"
		;;
	esac
}

func_db_profile ()		# insert into PROFILE values('hello!',10);
{
	case $1 in
		init)
			local SEPARATE OBJ LIST="$( func_db_profile all )"
			
			for OBJ in $LIST; do {
				eval $(func_db_profile $OBJ)
				echo -n "${SEPARATE}${OBJ} $SQLCLASS" && SEPARATE=","
			} done
		;;
		all)
			echo -n "ID DESC VALIDITY MAXTRAFFALL MAXTRAFFPERDAY MAXSPEEDUP MAXSPEEDDOWN MAXTIMEALL MAXTIMEPERDAY LANDINGURL COST CURRENCY"
		;;
		ID)
			case $2 in
				all)
					echo -n "ticket_24h ticket_48h ticket_1monat"
				;;
				*)
					echo "SQLCLASS='INTEGER PRIMARY KEY'"
				;;
			esac
		;;
		DESC)
			case $2 in
				ticket_24h)
					echo -n "1-Tages-Ticket f&uuml;r G&auml;ste"
				;;
				ticket_48h)
					echo -n "2-Tages-Ticket f&uuml;r G&auml;ste"
				;;
				ticket_1monat)
					echo -n "Monatsticket f&uuml;r Mitarbeiter"
				;;
				*)
					echo "SQLCLASS='TEXT'"
				;;
			esac
		;;
		VALIDITY)
			echo "SQLCLASS='INTEGER'"
		;;
		MAXTRAFFALL)
			echo "SQLCLASS='INTEGER'"
		;;
		MAXTRAFFPERDAY)
			echo "SQLCLASS='INTEGER'"
		;;
		MAXSPEEDUP)
			echo "SQLCLASS='INTEGER'"
		;;
		MAXSPEEDDOWN)
			echo "SQLCLASS='INTEGER'"
		;;
		MAXTIMEALL)
			echo "SQLCLASS='INTEGER'"
		;;
		MAXTIMEPERDAY)
			echo "SQLCLASS='INTEGER'"
		;;
		LANDINGURL)
			echo "SQLCLASS='TEXT'"
		;;
		COST)
			echo "SQLCLASS='INTEGER'"
		;;
		CURRENCY)
			echo "SQLCLASS='TEXT'"
		;;
	esac
}
