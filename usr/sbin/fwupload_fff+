#!/bin/sh
. /tmp/loader

_usage ()
{
	echo "Usage: $0 ( start | list | check <functionfile> | search <string> | show_functions <specific_function> | replace <string1> <string2> )"
}

_filelist ()
{
	local FILE LIST
	
	LIST="/etc/kalua/* /etc/kalua_init /etc/init.d/S41build_static_netparam /usr/bin/neigh"
	LIST="$LIST /www/cgi-bin-speed /www/cgi-bin-welcome /usr/bin/scheduler"
	LIST="$LIST /www/cgi-bin-admin /www/cgi-bin-sql /www/cgi-bin-chip /usr/sbin/cron.monitoring"
	LIST="$LIST /etc/dhcp-script.d/10dhcpscript /usr/sbin/cron.upgrade_packages /usr/sbin/cron.optimize_wifi_txpower"
	LIST="$LIST /etc/init.d/S90ipip_tunnel"
	
	for FILE in $LIST; do {
		echo $FILE
	} done
	
	find / -type f -name "*fff+" |
	 grep -v safed_syslog |
	  grep -v network_ |
	   grep -v S03a |
	    grep -v /tmp/ |
	     grep -v placeholder |
	      grep -v rom |
	       grep -v 40- |
	        grep -v ghost |
	         grep -v 15- |
	          grep -v 16- |
	           grep -v 17- |
	            grep -v reboot_count |
	             sort -n
}

_build_archiv ()
{
	tar cvzf $ARCHIV $( _filelist )
}

_vars ()
{
	ARCHIV="/tmp/changes.tgz"
	SERVER="hs@www.datenkiste.org:/tmp"
}

_upload ()
{
	scp $ARCHIV $SERVER
	rm $ARCHIV
}


case $1 in
	check)
		FILELIST="$2"
		[ -z "$FILELIST" ] && FILELIST="$( _filelist )"
		
		for FILE in $FILELIST; do {
			echo "checking '$FILE':"
			LIST="$( sed -n 's/^\(.*\) ().*/\1/p' "$FILE" )"
		
			for FUNCNAME in $LIST; do {
				sed "/^${FUNCNAME} ()/,/^}/!d" "$FILE" >/tmp/CHECK_$$
				echo "- checking $FUNCNAME ()"
				.  /tmp/CHECK_$$ || break
				rm /tmp/CHECK_$$
			} done
		} done
	;;
	start)
		_vars
		_build_archiv
		_upload
	;;
	list)
		FULLSIZE=0
		FULLSTRIP=0
		FULLLINES=0
	
		for FILE in $( _filelist ); do {
			[ -e "$FILE" ] && {
			
			SIZE="$( _file size "$FILE" )"
			LINES="$( cat "$FILE" | wc -l )"
			FULLLINES=$(( $FULLLINES + $LINES ))
			FULLSIZE=$((  $FULLSIZE + $SIZE ))
			STRIPPED_SIZE="$( sed 's/[ 	]*$//' "$FILE" | wc -c )"
			STRIPPED_DIFF="$(( $SIZE - $STRIPPED_SIZE ))"
			[ "$STRIPPED_DIFF" -gt 0 ] && {
				FULLSTRIP=$(( $FULLSTRIP + $STRIPPED_DIFF ))
				STRIPPED_DIFF="  --> $STRIPPED_DIFF Bytes stripable"
			}
			
			case ${#SIZE} in
				4) SIZE=" $SIZE" ;;
				3) SIZE="  $SIZE" ;;
				2) SIZE="   $SIZE" ;;
				1) SIZE="    $SIZE" ;;
			esac
				
				echo "$SIZE   $FILE $STRIPPED_DIFF Bytes stripable / $LINES lines"
			}
		} done
		
		echo "size overall: $FULLSIZE bytes $FULLLINES lines ($FULLSTRIP bytes stripable)"
	;;
	search)
		FILELIST="$3"
		[ -z "$FILELIST" ] && FILELIST="$( _filelist )"
		
		for FILE in $FILELIST; do {
			[ -e "$FILE" ] && {
				grep -q "$2" "$FILE" && {
					echo "found in '$FILE' :"
					
					sed -n "/$2/s/^[ 	]*\(.*\)/  : \1/p" "$FILE" 2>/dev/null || {	# remove leading whitespaces/tabs
					
						grep "$2" "$FILE"	# for special patterns
					}
					
					echo ""
				}
			}
		} done
	;;
	show_functions)
		for FILE in $( _filelist ); do {
			LIST_FUNCTIONS="$( sed -n 's/^\([a-zA-Z_]*\) ().*/\1/p' $FILE )"
		
			[ -n "$2" ] && LIST_FUNCTIONS="$( sed -n "s/^\($2\) ().*/\1/p" $FILE )"
			
			for FUNCTION in $LIST_FUNCTIONS; do {
			
				# echo "$FUNCTION"
			
				COUNT=0
				for FILE2 in $LIST; do {
				
					[ -n "$( grep "$FUNCTION" "$FILE2" | grep -v "^${FUNCTION} ().*" )" ] && {
						echo "		found call to '$FUNCTION' in '$FILE2'"
						COUNT=$(( $COUNT + $( grep "$FUNCTION" $FILE2 | grep -v "^${FUNCTION} ().*" | sed -n '$=' ) ))
					}
				} done
				
				echo "$COUNT times found $FUNCTION (defined in '$FILE')"
			} done
		} done
	;;
	cat_func)
		FUNCNAME="$2"
		
		for FILE in $( _filelist ); do {
			sed "/^${FUNCNAME} ()/,/^}/!d" $FILE
		} done
	;;
	replace)
		SEARCH="$2"
		REPLACE="$3"
		FILELIST="$4"
		
		[ -z "$FILELIST" ] && FILELIST="$( _filelist )"
		
		for FILE in $FILELIST; do {
			#sed -i 's/_log do \([^ daemon info ]*\) \(.*\)/_log do \1 daemon info \2/p' "$FILE"
			sed -i "s/${SEARCH}/${REPLACE}/g" "$FILE"
		} done
	;;
	strip_doubles_lines)
		for FILE in $( _filelist ); do {
		#for FILE in "/etc/kalua/http"; do {
			_log do strip_doubles daemon debug "working on '$FILE'"
		
			NUM=0
			while [ $NUM -lt $( _file lines "$FILE" ) ]; do {
				NUM=$(( $NUM + 1 ))
				MD5_NEW="$( sed "${NUM}q;d" "$FILE" | md5sum | cut -d' ' -f1 )"
				
				if [ "$MD5_NEW" = "$MD5_OLD" ]; then
					echo "# lasse diese zeile aus:"
					sed "${NUM}q;d"	"$FILE"
					echo "#"
				else
					sed "${NUM}q;d" "$FILE" >>"${FILE}_tmp"
				fi
				
				MD5_OLD="$MD5_NEW"
			} done
			
			[ -e "${FILE}_tmp" ] && {
				if [ $( _file size "$FILE" ) -ne $( _file size "${FILE}_tmp" ) ]; then
					echo "stripped to '$FILE' = $( _file size "$FILE" )->$( _file size "${FILE}_tmp" ) Bytes"
					echo "key!";read KEY
					mv "${FILE}_tmp" "$FILE"
					chmod 777 "$FILE"
				else
					rm "${FILE}_tmp"
				fi
			}
		} done
	;;
	*)
		_usage
	;;
esac
