#!/bin/sh

. /etc/functions_base_fff+ && vars func_need log scheduler

func_scheduler_vars

ERR=1
while getopts "a:A:s:wrlpo" FLAG; do {

	ERR=0

	case $FLAG in
		a)
			func_scheduler_add "$OPTARG"
		;;
		s)
			func_log sleeping daemon debug "$OPTARG seconds"
			sleep "$OPTARG"
		;;
		w)
			echo >/dev/misc/crondog						# fixme! maybe also add cron.minutely here?
			func_log crondogs_friend daemon debug "heartbeat was send"
		;;
		r)
			func_scheduler_run
		;;
		l)
			func_scheduler_list_queue
		;;
		A)									# fixme! doubled entrys with -A ?
			func_log user_defined_now daemon debug "start '$OPTARG'"
			COMMAND="$( func_scheduler_task2command "$OPTARG" )"		# fixme! redirecting does not work?!
			func_scheduler_wait_till_cpuload_is_low "$COMMAND"
			$COMMAND
			func_log user_defined_now daemon debug "ready '$OPTARG' ('$COMMAND')"
		;;
		p)
			func_log purge_queues daemon info "removing"
			rm $FILE_SCHEDULER_TMP* $FILE_SCHEDULER $FILE_SCHEDULER_COPY 2>/dev/null
		;;
		o)
			grep -q ^"printdev()" /usr/bin/netparam || {	# fixme! better concept needed, wrong place (but efficient)!
				INCOMING_OLSR_PACKETS_WIRED="$( iptables --line-numbers -nxvL olsr_in_wire 2>/dev/null | sed -n 's/^4[^0-9]*\([0-9]*\)[^0-9]*[0-9]*.*/\1/p' )"
				[ ${INCOMING_OLSR_PACKETS_WIRED:=0} -gt 0 ] && {
					func_log detect_wired_olsr_traffic daemon info "restart olsr-daemon with wired interfaces"
					/etc/init.d/S41build_static_netparam restore_original_netparam
					/etc/init.d/S53olsrd restart
				}
			}
		;;
		*)
			ERR=1
		;;
	esac
} done

[ "$ERR" = "1" ] && func_scheduler_print_usage && exit 1
