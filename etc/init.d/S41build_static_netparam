#!/bin/sh
. /tmp/loader

# todo:
# with/without OLSR on all interfaces? or specific interfaces?

_build ()
{
	local FUNC="build"
	local FILE="/tmp/NETPARAM"

	_log do $FUNC daemon debug "working"
	/rom/usr/bin/netparam >$FILE && {
		_log do $FUNC daemon debug "successfully build '$FILE'"
		return 0
	}
	
	_log do $FUNC daemon crit "error during build, trying pivot-root"
	/usr/bin/netparam >$FILE && {
		_log do $FUNC daemon crit "success building '$FILE'"
		return 0
	}
	
	_log do $FUNC daemon crit "error, could not build '$FILE'"
	return 1
}

_restore_original_netparam ()
{
	local FUNC="restore_original_netparam"
	local ORIGINAL="/rom/usr/bin/netparam"
	local COPY="/usr/bin/netparam"
	
	local CRC_ORIGINAL="$( md5sum $ORIGINAL | cut -d' ' -f1 )"
	local CRC_COPY="$(     md5sum $COPY     | cut -d' ' -f1 )"

	[ "$CRC_ORIGINAL" = "$CRC_COPY" ] && {
		_log do $FUNC daemon debug "netparam seems to be fine"
		return
	}	

	_log do $FUNC daemon debug "CRC's differ - replacing netparam in filesystem with copy in rom"
	
	cp $ORIGINAL $COPY || {
		_log do $FUNC daemon debug "error during copy? trying to symlink"
		
		>$COPY		# create 0 byte-file
		rm $COPY
		ln -s $ORIGINAL $COPY && {
			_log do $FUNC daemon debug "symlinking went fine"
			return
		}
		_log do $FUNC daemon crit "error during symlinking"
		return 1
	}
	
	_log do $FUNC daemon debug "successfully replaced"
}

if [ -e /tmp/BOOT ] || [ "$1" = "restore_original_netparam" ]; then
	_restore_original_netparam
fi

_build

/etc/kalua_init		# this includes a static version of NETPARAM
			# fixme! hook when 'ifup wan' gets an dhcp-lease
