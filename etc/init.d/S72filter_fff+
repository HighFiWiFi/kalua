#!/bin/sh

. /etc/variables_fff+

[ -n "$FAILSAFE" ] && exit
[ ! -e "$SOFTWARE_FULLY_INSTALLED" ] && exit

. /tmp/vars
. /etc/functions_fff+
. /etc/functions_logging_fff+

case $1 in
	start)
		scheduler -a startup_helper
	;;
	call)
		which hdparm >/dev/null && {
			func_log tune_ide_disc daemon info "setting spindown-time to 5 minutes and spinning down now"
			hdparm -y -S 60 /dev/discs/disc0/disc
			# fixme! is here the place to mount partitions, but needs some abstraction / look into freifunk-usbstick
		}
	
		[ -e "$PPPOE" ] && {
			func_log restart_pppoe daemon debug "kill running pppoecd"
			killall pppoecd
			
			func_log restart_pppoe daemon debug "bringing wan down"
			ifdown wan		# fixme! how to restart pppoe more elegant?
			
			func_log restart_pppoe daemon debug "bringing wan up"
			ifup wan
			
			if pidof pppoecd >/dev/null ; then
				func_log restart_pppoe daemon debug "pppoecd now running"
			else
				func_log restart_pppoe daemon crit "failed to restart pppoecd"
			fi
		}
	
		/etc/local.fw-fff+ olsr_whitelist_update
		/etc/local.fw-fff+ adduser 99:99:99:99:99:94 99.99.99.99	# fixme! howto initiate reserved_user_chain?
		/etc/init.d/S99an_olsr_dev_check_fff+ call
		/etc/init.d/S69watch_olsrd_fff+ send_alive_message

		touch $NETFILTER						# fixme!
	;;
	*)
		func_log print_usage daemon debug "Usage: $0 (start|call)"
	;;
esac
