#!/bin/sh
. /tmp/loader

[ ! -e "/www/SOFTWARE_FULLY_INSTALLED" ] && exit

fkt_patch_netparam ()
{
	local FUNC="patch_netparam"
	local MODE="$1"
	local ORIG="/rom/usr/bin/netparam"
	local COPY="/usr/bin/netparam"

	[ "$MODE" = "restore" ] && {
		_log do $FUNC daemon info "restoring '$COPY' from '$ORIG' (or copy already made)"
		rm $COPY
		cp $ORIG $COPY
		return
	}
	
	_log do $FUNC daemon info "generating new '$COPY', simulating wifi-olsr-only device"
	
	rm $COPY
	echo -en "#!/bin/sh\n\ncat<<EOF\n"  >$COPY 	# intro of script
	$ORIG | grep -v ANOLSR		   >>$COPY	# original-output in script (without LAN/WAN-OLSR-statements)
	echo -en "\n# attention, look at $0 - this is\n# only a fakefile, original is here: \"$COPY\"\nEOF\n" >>$ORIG
	chmod +x $COPY
}

fkt_check_if_only_wifi_olsr ()
{
	local FUNC="check_if_only_wifi_olsr"
	local FILE="/tmp/table.links.txt"

	wget -O - http://127.0.0.1:2006/neighbours | sed -e '/./{H;$!d;}' -e 'x;/Table: Links/!d;' | sed -e '/0\.00/!d' >$FILE

	COUNT_ALL="$( cat $FILE | wc -l )"
	COUNT_WIFI="$( fgrep "$WIFIADR" $FILE | wc -l )"
	
	rm $FILE
	
	if [ "$COUNT_ALL" = "$COUNT_WIFI" ] && [ "$COUNT_WIFI" != "0" ]; then		# fixme! this does not work for tun/tap-neighbours / VPN!
		
		_log do $FUNC daemon info "only wifi-olsr"
	else
		_log do $FUNC daemon info "olsr also (or only) on wired-interfaces"
		return 1
	fi
}

case $1 in
	call)
		fkt_check_if_only_wifi_olsr && {
			fkt_patch_netparam replace
			_scheduler add "restart_olsr"
		}
	;;
	replace)
		fkt_patch_netparam replace
		_scheduler add "restart_olsr"
	;;
	recheck)
		OUT_OLSR="$( _olsr neighs )" && {
			_olsr neigh_check_for_nonwifi $OUT_OLSR && {
				_log do recheck daemon info "no need for recheck, there are non_wifi neighbours"
				exit
			}
		}
	
		fkt_patch_netparam restore
		
		_log do recheck daemon info "restart OLSRd using parameters of actual netparam-script"
		/etc/init.d/S53olsrd restart
		
		_log do recheck daemon info "waiting 120 seconds"
		
		fkt_check_if_only_wifi_olsr && {
			fkt_patch_netparam replace
			_scheduler add "restart_olsr"
		}
	;;
	restart_olsr)
		_log do restart_olsr daemon info "using parameters of actual netparam-script"
		/etc/init.d/S53olsrd restart
	;;
	start)
		_scheduler add "$0 call"	
	;;
	*)
		_log do output_help daemon info "printing"
		echo "Usage: $0 (call|replace|recheck|restart_olsr)"
	;;
esac
