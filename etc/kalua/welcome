_welcome_htmlout_user_over_limit ()
{
	local MAC="$( _net ip2mac $REMOTE_ADDR )"
	local LIMIT_IN_MB="$( fkt_convert_to_unit $(fkt_get_daily_traffic_limit_in_bytes_from_user_with_mac $MAC ) mb )"

	logger "fff+ $0 (_welcome htmlout_user_over_limit)"

	cat <<EOF
<big><b>
Leider wurdest du ausgeloggt, weil du zuviel Datenverkehr verursacht hast.<br>
Momentan darf dein Rechner $LIMIT_IN_MB Megabytes pro Tag verursachen.<br>
Ein erneuter Login ist ab 6 Uhr Vormittag wieder m&ouml;glich.<br>
EOF
										

	# hinweis auf netzinterne dienste?

	fkt_list_locally_registered_users | grep -i -q $MAC

	test "$?" -eq 0 && return							# user is already registered

	logger "fff+ $0 (_welcome htmlout_user_over_limit) unregistered"

	cat <<EOF
Sollte daran etwas falsch sein, spreche mit dem Administrator dieses Netzknotens.	<br>
Dieser kann dich auf diesem Knoten registrieren - dann ist mehr drin ;-)		<br>
Bei Problemen kannst du auch das <a href="http://wireless.subsignal.org/index.php?title=Telefonnummer">Weimarnetz-Sorgentelefon</a> anrufen: 03643 / 544304
</b></big>
EOF
}

_welcome_htmlout_user_blackisted ()
{
	logger "fff+ $0 (_welcome htmlout_user_blackisted)"

	cat <<EOF
<big><b>
Dieser Netzknoten wurde f&uuml;r die Benutzung durch andere Benutzer gesperrt.<br>
Dies kann verschiedene Ursachen haben. Es besteht nat&uuml;rlich die M&ouml;glichkeit,<br>
das Du dir eine eigene Freifunkantenne ("Router") aufstellst.<br>
Mehr Informationen dazu findest du unter <a href="$WIKI_MAIN_URL">$WIKI_MAIN_URL</a> .<br>
Bei Problemen kannst du auch das <a href="http://wireless.subsignal.org/index.php?title=Telefonnummer">Weimarnetz-Sorgentelefon</a> anrufen: 03643 / 544304
</b></big>
EOF
}

_welcome_htmlout_user_yet_logged_in ()
{
	_log do welcome_htmlout_user_yet_logged_in daemon debug "working"

	echo "<small>(Hinweis: du bist schon eingeloggt)</small>"
}

_welcome_admin_url ()
{
	_wget do "http://$1/cgi-bin-index.html" 3 | sed -n '/<LI>/{n;p;q}' | grep -v "Berliner Webseite"
}

_welcome_htmlout_gateway_intropic ()
{
	func_need profile_user
	
	test ! -e /tmp/ARCHIV_TRACEINET && /usr/sbin/cron.check_inet_gw_fff+ >/dev/null

	eval "$( tail -n 1 /tmp/ARCHIV_TRACEINET 2>/dev/null )"

	cat <<EOF
Der Internetzugang wird dir gerade von diesem freundlichen<br>
Netzteilnehmer zur Verf&uuml;gung gestellt: "<b>$( _net ip2dns $GW )</b>" (Knoten $( func_ipsystem $GW ))<br>
<a href="http://$GW/cgi-bin-index.html"><img src="http://$GW/images/intro.jpg" border=0 width=240 height=180 alt="Hier sollte eigentlich das Startbild deines Internet-Einspeisers zu sehen sein."></a>
EOF

	_welcome admin_url $GW

	if [ "$GW" != "$NEXTHOP" ]; then
		cat <<EOF
<br><br>Dies ist dein n&auml;chster Funknachbar: "<b>$( _net ip2dns $NEXTHOP )</b>" (Knoten $( func_ipsystem $NEXTHOP ))<br>
<a href="http://$NEXTHOP/cgi-bin-index.html"><img src="http://$NEXTHOP/images/intro.jpg" border=0 width=240 height=180 alt="Hier sollte eigentlich das Startbild deines naechsten Funknachbars &uuml;ber den das Internet geleitet wird zu sehen sein."></a>
EOF
		_welcome admin_url $NEXTHOP
	else
		echo "<br><br>Das ist auch dein n&auml;chster Funknachbar!<br>"
	fi
}

_welcome_usercase_decide ()
{
	if [ "$REQUEST_METHOD" = "POST" ]; then			# fixme! a simple POST is enough?
		USECASE="BUTTON_PRESSED"
	else
		eval $( _http query_string_sanitize )		# fixme! also check: already logged in?
		USECASE="LOOK_ONLY"
	fi
	
	_log do decide_usecase daemon info "USECASE: '$USECASE' REMOTE_ADDR: '${REMOTE_ADDR}'"
}


_welcome_htmlout_header
{
	export DATE="$(grep SVN "/etc/variables_fff+" | cut -d"#" -f2)"
	export TITLE="Weimarnetz-Infoseite"
	SCRIPT=${0#/rom}
	. ${SCRIPT%/*}/cgi-bin-pre.sh
}

_welcome_htmlout_footer ()
{
	. ${SCRIPT%/*}/cgi-bin-post.sh
}

_welcome_htmlout_submitbutton_start ()
{
	echo '<form action="" method="POST"><input type="submit" value="Internetverbindung aufbauen"></form>'
}

_welcome_htmlout_indexpage ()
{
	sh /www/cgi-bin-index.html
}

_welcome_htmlout_message_maintenance ()
{
	echo "Router befindet sich gerade im Wartungs-Modus oder in der Startphase, bitte keinen Datenverkehr verursachen."
}

_welcome_htmlout_message_wifi ()
{
	echo "Hallo Nutzer. Du musst noch unten auf den Knopf dr&uuml;cken!<br>"
	echo "Versuche Dich in Zukunft per Kabel ans Weimarnetz anzuschliessen, es geht dann schneller.<br>"
	echo "Bei Problemen kannst du auch das <a href="http://wireless.subsignal.org/index.php?title=Telefonnummer">Weimarnetz-Sorgentelefon</a> anrufen: 03643 / 544304"
}

_welcome_htmlout_link_usermanagement ()
{
	cat <<EOF
<table cellspacing=0 cellpadding=0 border=0 width=100%><tr><td align=right width=100%>
<a href="/cgi-bin/config_fff+?gui=user"><small>...diesen Computer fest eintragen</small></a></td></tr></table>
EOF
}

_welcome_htmlout_message_lan ()
{
	echo "Hallo Nutzer. Du musst noch unten auf den Knopf dr&uuml;cken!<br>"
	echo "Bei Problemen kannst du auch das <a href="http://wireless.subsignal.org/index.php?title=Telefonnummer">Weimarnetz-Sorgentelefon</a> anrufen: 03643 / 544304"
}

_welcome_htmlout_message_welcome ()
{
	local BORDER

	if [ "$( fkt_check_if_mac_is_admin $MAC )" != "true" ]; then
		BORDER="$( fkt_convert_to_unit $(fkt_get_daily_traffic_limit_in_bytes_from_user_with_mac $MAC ) mb ) Megabytes/Tag"
	else
		BORDER="unbegrenzt"
	fi

	cat <<EOF
Viel Spass beim Surfen.
<i>Tipp</i>: Du erreichst diese Seite immer unter <b>
<tt>http://$( nvram get wan_hostname )</tt></b><br>
<small>Dein Benutzerstatus erlaubt Dir
$BORDER Internetdatenverkehr (siehe <a href="/cgi-bin/config_fff+?gui=user">Benutzerverwaltung</a>).</small><br>
EOF
}

_welcome_remoteaddr_is_from_wifi ()
{
	grep -q "$REMOTE_ADDR_ESCAPED;" $CLIENTS_WIFI 2>/dev/null && {
		echo "true"
		return
	}
}

_welcome_remoteaddr_is_from_lan ()
{
	grep -q "$REMOTE_ADDR_ESCAPED;" $CLIENTS_LAN 2>/dev/null && {
		echo "true"
	}
}

_welcome_remoteadd_is_from_wan ()
{
	grep -q "$REMOTE_ADDR_ESCAPED;" $CLIENTS_WAN 2>/dev/null && {
		echo "true"
	}
}

_welcome_maintenance_check ()
{
	[ ! -e "/www/SOFTWARE_FULLY_INSTALLED" ] && {
		echo "true"
	}
}

_welcome_mode_decide ()
{
	REMOTE_ADDR_ESCAPED="$( echo $REMOTE_ADDR | sed 's/\./\\\./g' )"

	  if [ "$USECASE" = "BUTTON_PRESSED" ]; then
	  	MODE=BUTTON

  	elif [ "$(_welcome maintenance_check)" = "true" ]; then
  		MODE=SERVICE
  	
	elif [ ! -z "$(_welcome remoteaddr_is_from_wifi)" ] && [ "$REDIRECTED" != "1" ]; then
		MODE=REDIRECT_WIFI
	
	elif [ ! -z "$(_welcome remoteaddr_is_from_wifi)" ]; then
		MODE=WIFI

	elif [ ! -z "$(_welcome remoteaddr_is_from_lan)" ] && [ "$REDIRECTED" != "1" ]; then
		MODE=REDIRECT_LAN

	elif [ ! -z "$(_welcome remoteaddr_is_from_lan)" ]; then
		MODE=LAN
	
	elif [ ! -z "$(_welcome remoteadd_is_from_wan)" ] && [ "$REDIRECTED" != "1" ]; then
		MODE=REDIRECT_WAN
	
	elif [ ! -z "$(_welcome remoteadd_is_from_wan)" ]; then
		MODE=WAN
	else
		MODE=MESH
	fi
	
	logger "fff+ (_welcome mode_decide) $0 : \"$MODE\""

	[ -z "$DEBUG" ] && return

	case "$DEBUG" in
		1) MODE=SERVICE       ;;
		2) MODE=BUTTON        ;;
		3) MODE=REDIRECT_WIFI ;;
		4) MODE=WIFI          ;;
		5) MODE=REDIRECT_LAN  ;;
		6) MODE=LAN           ;;
		7) MODE=REDIRECT_WAN  ;;
		8) MODE=WAN           ;;
		*) MODE=MESH          ;;
	esac

	logger "fff+ (_welcome mode_decide,debug) $0 : \"$MODE\""
}

_welcome_htmlout_news ()
{				# SENS: loads a file containing the 10 latest news from the newsserver, created by A. Braeu
	local URL="$1"		# ARG1: string,URL
	local HEAD="$2"		# ARG2: string,headline

	cat <<EOF
	<P><table cellspacing=0 cellpadding=0 border=0 width=100%><tr><td align=left width=50%><big><b> $HEAD </b></big></td>
	</tr></table></p>
	<A HREF="${NEWSSERVER_URL}" TARGET="_blank">Direktlink</A> zum Newsserver - Benutzername: <I>freifunk</I> Passwort: <I>weimar</I><BR>
EOF

        _wget do "${URL}" 2 | sed -e 's/Ã¤/ä/g' -e 's/Ã¼/ü/g' -e 's/Ã¶/ö/g'	# fetch this page but abort after max 3 seconds	and convert german umlauts

	test "$?" -ne 0 && echo "Fehler aufgetreten...<br>Hier sollten eigentlich aktuelle Diskussionen vom Newsserver/Mailingliste stehen.<br><br>"
}	

_welcome_htmlout_wikipage ()
{
	local  URL="${WIKI_MAIN_URL}/index.php"
	local PAGE="$1"
	local HEAD="$2"

	cat <<EOF
<p><table cellspacing=0 cellpadding=0 border=0 width=100%><tr><td align=left width=50%><big><b> $HEAD </b></big></td>
<td align=right width=50%><a href="${URL}?${PAGE}&action=edit"><small>Text bearbeiten</small></a></td></tr></table></p>
EOF
	which awk >/dev/null && {
		_wget do "${URL}?${PAGE}" 2 | awk -v URL=$URL '{		# fetch this page but abort after max 3 seconds
			gsub(/\/index.php/,URL)
			gsub(/Ã¤/,"ä")						# utf8
			gsub(/Ã¼/,"ü")						# utf8
			gsub(/Ã¶/,"ö")						# utf8 - yet missing: the big german umlauts + sz
			if(s==1)
				print
			if(substr($0,4,24)=="<div class=\"editsection\"" || index($0,"class=\"mw-headline\"")>0)
				s=1
			if(s==1 && substr($0,1,11)=="</li></ul>")		# Problem: only lists are possible (end-detection...)
				exit
		}END{if(s!=1)exit 1}'
	}
	
	if [ "$?" -ne 0 ] || ! which awk >/dev/null; then		# fixme! awk -> sed
		cat <<EOF						# fetching wikipage was NOT successful
		Fehler aufgetreten...<br>
		Hier sollte eigentlich ein Auszug<br>
		aus dem Weimarnetz-Wiki (<a href="${URL}?${PAGE}">"${PAGE}"</a>) stehen.
		<br><br>
EOF
		logger "fff+ (_welcome htmlout_wikipage) failed to retrieve: \"${URL}?${PAGE}\""
	fi
}
