#!/bin/sh

# this outputs an inital small loader which can be sourced for each 'class', e.g. for class 'wifi':
#
# idee: kommentare etc. strippen beim zusammenbau
# idee: methode 'unload' ?
# idee: methode help?
# idee: $FUNCNAME fuellen ODER alle Vorkommen von FUNCNAME durch realen zur "compile-zeit" ersetzen
# idee: funktionsausrufe innerhalb der klasse optimieren, d.h. innerhalb von _wifi wird der aufruf "_wifi txpwr_get" durch _wifi_txpwr_get ersetzt
# idee: passend zur klasse automatisch einen bestimmten variablensatz aktivieren (z.b. INTRANET bei pfilter)?
#
# todo: option zum entfernen aller logmeldungen? (bzw. nur log-debug)
# todo: lade-log an/aus (loader/realclass)
#
# idee: kommentare etc. strippen beim zusammenbau
# - kommentare entfernen
# - fuehrende spaces oder tabs entfernen
# - trailing spaces oder tabs entfernen
# - leerzeilen entfernen
# - aufpassen, das dies nicht innerhalb von cat <<EOF EOF passiert


BASEDIR="/etc/kalua"	# scriptbase, simply throw your 'class'-files here e.g. wifi
LOADER="/tmp/loader"	# scripts can source this file and automatically use all 'classes'
POOLDIR="/tmp/kalua"	# all function-scripts are rewritten (stripped) to this dir

mkdir -p "$POOLDIR"

echo  >"$LOADER" "# generated by $0"
echo >>"$LOADER" "export TZ='CET-1CEST-2,M3.5.0/2,M10.5.0/3'"
	
for CLASS in $(find $BASEDIR -type f); do {
	CLASS="$( basename $CLASS )"			# generate class_loader + method 'show' + method 'include':

	cat >"$POOLDIR/${CLASS}" <<EOF
_${CLASS}(){ local F=\$1;shift; logger "realclass:'$CLASS' name:'\$F' args:'\$@'" ;_${CLASS}_\$F "\$@";}
_${CLASS}_show(){ sed -n 's/^\(.*\) ().*/\1/p' $BASEDIR/${CLASS} | sort ;}
_${CLASS}_include(){ :;}
EOF
	cat >>"$POOLDIR/${CLASS}" $BASEDIR/$CLASS	# copy all functions to pool

	echo -en >>"$LOADER" "_${CLASS}(){ . $POOLDIR/${CLASS};local F=\$1;shift; logger -- \"--- loader:'$CLASS' name:'\$F' args:'\$@'\" ;_${CLASS}_\$F \"\$@\";}\n"
} done

[ -e /tmp/NETPARAM ] && {				# fixme! better concept needed
	. /tmp/NETPARAM
	
	while read LINE; do {
		echo >>"$LOADER" -n "${LINE};"
	} done </tmp/NETPARAM
	
	echo -en >>"$LOADER" "WIFI_DEVS=$WIFIDEV\n"
}

. /etc/variables_fff+
echo >>"$LOADER" "FFF_PLUS_VERSION=$FFF_PLUS_VERSION;FFF_VERSION=$FFF_VERSION"

# COUNT="($( sed -n "s/^\(.*\) ().*/\1/p" $BASEDIR/${CLASS} | wc -l | sed 's/ //g') functions)"
# logger -s "generated shortpre + method 'show' to '$POOLDIR/${CLASS}' ${COUNT}"
