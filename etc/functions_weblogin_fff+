FUNC_WEBLOGIN=1

func_weblogin_output_loginpage ()			# needs: images/logo.gif|logo2.gif		+ images/flag_de|en|fr.gif
{							#        images/button_login_de.gif		+ images/bgcolor.txt
	func_http_header_mime_output "text/html"	#        /favicon.ico
	
	local BGCOLOR="$( cat /www/images/bgcolor.txt 2>/dev/null )"
	local SLOGAN="$( test -e /www/images/logo2.gif && echo -n '<IMG SRC="images/logo2.gif" TITLE="Hotel-Slogan" ALT="Hotel-Slogan"><BR><BR>' )"

	cat <<EOF
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD>
<TITLE>Weblogin</TITLE>
<META HTTP-EQUIV="cache-control" CONTENT="no-cache">
<META HTTP-EQUIV="content-type" CONTENT="text/html; charset=ISO-8859-15">
<LINK REL="shortcut icon" TYPE="image/x-icon" HREF="/favicon.ico">
</HEAD>
<BODY BGCOLOR="${BGCOLOR:-white}" TEXT="black"><CENTER>
<A HREF="#" TITLE="diese Seite in deutsch anzeigen"><IMG SRC="images/flag_de.gif" BORDER="0" ALT="de" TITLE="diese Seite in deutsch anzeigen">&nbsp;deutsch</A>
&nbsp;&nbsp;<A HREF="#" TITLE="show this page in english"><IMG SRC="images/flag_en.gif" BORDER="0" ALT="en" TITLE="show this page in english">&nbsp;english</A>
&nbsp;&nbsp;<A HREF="#" TITLE="afficher cette page en anglais"><IMG SRC="images/flag_fr.gif" BORDER="0" ALT="fr" TITLE="afficher cette page en anglais">&nbsp;fran&ccedil;ais</A>
<BR><BR>${SLOGAN}<IMG SRC="images/logo.gif" TITLE="Hotel-Logo" ALT="Hotel-Logo"><FORM METHOD="post" ACTION="">
<TABLE CELLSPACING="0" CELLPADDING="0" BORDER="0">
<TR><TD ALIGN="CENTER"><BR><B><BIG>Internetzugang</BIG></B></TD></TR>
<TR><TD ALIGN="CENTER"><BR><TABLE CELLSPACING="0" CELLPADDING="2" BORDER="0">
<TR><TD ALIGN="RIGHT">Benutzername:&nbsp;<INPUT TYPE="text" SIZE="10" MAXLENGTH="30" NAME="FORM_USER"></TD></TR>
<TR><TD ALIGN="RIGHT">Passwort:&nbsp;<INPUT TYPE="password" SIZE="10" MAXLENGTH="10" NAME="FORM_PASS"></TD></TR></TABLE></TD></TR>
<TR><TD ALIGN="CENTER"><BR><INPUT TYPE="checkbox" NAME="FORM_RULES" checked>&nbsp;Ich akzeptiere die <A HREF="#RULES" TITLE="ausf&uuml;hrliche Informationen zu den Vertragsbedingungen">Nutzungsbedingungen</A></TD></TR>
<TR><TD ALIGN="CENTER"><BR><INPUT TYPE="image" SRC="images/button_login_de.gif" ALT="&rarr;Login"></TD></TR>
</TABLE></FORM></CENTER>
</BODY></HTML>
EOF
}

func_weblogin_output_login_error ()
{
	func_http_redirect 302 ip_wifi
}

func_weblogin_output_errorpage ()
{
	func_http_header_mime_output "text/html"
	
	cat <<EOF
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD>
<TITLE>Weblogin</TITLE>
<META HTTP-EQUIV="cache-control" CONTENT="no-cache">
<META HTTP-EQUIV="content-type" CONTENT="text/html; charset=ISO-8859-15">
<LINK REL="shortcut icon" TYPE="image/x-icon" HREF="/favicon.ico">
</HEAD>
<BODY BGCOLOR="white" TEXT="black"><CENTER>
<h3>Netzwerkfehler entdeckt, bitte benutzen Sie einen anderen Zugangspunkt.</h3>
<h3>Error in network detected, please use another accesspoint.</h3>
<h3>Erreur de reseau apparu, veuillez utiliser un autre point d' access.</h3>
<hr width='90%'>
<h3>Die Administration wurde benachrichtigt.</h3>
<h3>The administration was notified.</h3>
<h3>L' administration a obtenu une information.</h3>
</BODY></HTML>
EOF
}

func_weblogin_check_login ()		# fixme! send HOSTNAME?
{					# fixme! answer must be a challenge/response:	// prevent replay attacks!
	local USER="$1"			#        1. send hash of user/pass
	local PASS="$2"			#        2. server answers with hash_of(1+my_secret_sshid) + auth=true/false
	local MAC="$3"			#        3. we calc same hash and compare

	local CRC="$( echo -n "${USER}${PASS}" | md5sum | cut -d' ' -f1 )"
	local GATEWAY="$( sed -n '${s/^.* GW=\([0-9\.]*\);.*/\1/p}' /tmp/archiv_trace_inet_gateway_fff+ 2>/dev/null )"	# func_need gwcheck

	local ANSWER="$( wget -qO - "http://${GATEWAY:-127.0.0.1}/cgi-bin-sql?LOGIN=$CRC" 2>/dev/null )"
	
	[ "$ANSWER" = "1" -o -e /tmp/FREE ] && {
		echo "$CRC" >/tmp/vds_user_$MAC		# for building vds
		return 0
	}
	
	return 1
}
